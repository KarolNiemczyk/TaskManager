<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pl">
<head th:replace="~{fragments/header :: header('Lista zadań')}"></head>
<body>

<div class="container my-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Zadania (<span th:text="${tasks.totalElements}">0</span>)</h2>
        <div class="d-flex gap-2">
            <a th:href="@{/tasks/new}" class="btn btn-success btn-lg">+ Nowe zadanie</a>
            <a th:href="@{/tasks/download}" class="btn btn-outline-info btn-lg">Pobierz CSV</a>
            <a th:href="@{/tasks/statistics/download}" class="btn btn-outline-primary btn-lg">Statystyki CSV</a>
        </div>
    </div>

    <form th:action="@{/tasks}" method="get"
          class="row g-3 mb-4 bg-light p-4 rounded shadow-sm">

        <div class="col-md-3">
            <input type="text"
                   name="title"
                   class="form-control"
                   placeholder="Szukaj po tytule"
                   th:value="${title}">
        </div>

        <div class="col-md-2">
            <select name="status" class="form-select">
                <option value="">Wszystkie statusy</option>
                <option value="TODO" th:selected="${status?.name() == 'TODO'}">Do zrobienia</option>
                <option value="IN_PROGRESS" th:selected="${status?.name() == 'IN_PROGRESS'}">W trakcie</option>
                <option value="DONE" th:selected="${status?.name() == 'DONE'}">Zrobione</option>
            </select>
        </div>

        <div class="col-md-3">
            <select name="categoryId" class="form-select">
                <option value="">Wszystkie kategorie</option>
                <option th:each="c : ${categories}"
                        th:value="${c.id}"
                        th:text="${c.name}"
                        th:selected="${c.id == categoryId}">
                </option>
            </select>
        </div>

        <div class="col-md-2">
            <select name="sortProperty" class="form-select">
                <option value="createdAt" th:selected="${sortProperty == 'createdAt'}">Data utworzenia</option>
                <option value="updatedAt" th:selected="${sortProperty == 'updatedAt'}">Data aktualizacji</option>
                <option value="dueDate" th:selected="${sortProperty == 'dueDate'}">Termin</option>
                <option value="title" th:selected="${sortProperty == 'title'}">Tytuł</option>
            </select>
        </div>

        <div class="col-md-2">
            <select name="sortDirection" class="form-select">
                <option value="asc" th:selected="${sortDirection == 'asc'}">Rosnąco</option>
                <option value="desc" th:selected="${sortDirection == 'desc'}">Malejąco</option>
            </select>
        </div>

        <input type="hidden" name="size" th:value="${size}"/>

        <div class="col-md-12 d-flex gap-2 justify-content-end">
            <button type="submit" class="btn btn-primary">Zastosuj</button>
            <a th:href="@{/tasks}" class="btn btn-outline-secondary">Wyczyść</a>
        </div>
    </form>

    <!-- BRAK ZADAŃ -->
    <div th:if="${tasks.empty}" class="text-center py-5">
        <h4 class="text-muted">Brak zadań spełniających kryteria</h4>
        <a th:href="@{/tasks/new}" class="btn btn-outline-primary btn-lg">Dodaj pierwsze zadanie</a>
    </div>

    <!-- LISTA ZADAŃ -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" th:unless="${tasks.empty}">
        <div class="col" th:each="t : ${tasks.content}">
            <div class="card h-100 shadow">
                <div class="card-body">
                    <h5 th:text="${t.title}">Tytuł</h5>
                    <p th:text="${t.description ?: 'Brak opisu'}"></p>

                    <!-- STATUS -->
                    <div class="mb-2">
                        <span class="badge"
                              th:text="${t.status}"
                              th:classappend="
                                ${t.status.name() == 'TODO'} ? 'bg-secondary' :
                                (${t.status.name() == 'IN_PROGRESS'} ? 'bg-warning text-dark' :
                                'bg-success')">
                        </span>
                    </div>

                    <div class="small">
                        <div th:if="${t.categoryName}">
                            <strong th:text="${t.categoryName}"></strong>
                        </div>

                        <div th:if="${t.dueDate}">
                            <span th:text="${#temporals.format(t.dueDate, 'yyyy-MM-dd')}"></span>
                        </div>
                    </div>
                </div>

                <div class="card-footer d-flex gap-2">
                    <a th:href="@{'/tasks/' + ${t.id}}" class="btn btn-outline-primary btn-sm">Edytuj</a>
                    <form th:action="@{'/tasks/' + ${t.id} + '/delete'}"
                          method="post"
                          onsubmit="return confirm('Na pewno usunąć?')">
                        <button class="btn btn-outline-danger btn-sm">Usuń</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- PAGINACJA -->
    <nav class="mt-5" th:if="${tasks != null and tasks.totalPages > 1}">
        <ul class="pagination justify-content-center">

            <li class="page-item" th:classappend="${tasks.first} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/tasks(page=0,
                                     size=${size},
                                     title=${title},
                                     status=${status},
                                     categoryId=${categoryId},
                                     sortProperty=${sortProperty},
                                     sortDirection=${sortDirection})}">
                    « Pierwsza
                </a>
            </li>

            <li class="page-item" th:classappend="${tasks.first} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/tasks(page=${tasks.number - 1},
                                     size=${size},
                                     title=${title},
                                     status=${status},
                                     categoryId=${categoryId},
                                     sortProperty=${sortProperty},
                                     sortDirection=${sortDirection})}">
                    ‹ Poprzednia
                </a>
            </li>

            <li class="page-item"
                th:each="i : ${#numbers.sequence(
                    T(java.lang.Math).max(0, tasks.number - 2),
                    T(java.lang.Math).min(tasks.totalPages - 1, tasks.number + 2)
                )}"
                th:classappend="${i == tasks.number} ? 'active'">
                <a class="page-link"
                   th:href="@{/tasks(page=${i},
                                     size=${size},
                                     title=${title},
                                     status=${status},
                                     categoryId=${categoryId},
                                     sortProperty=${sortProperty},
                                     sortDirection=${sortDirection})}"
                   th:text="${i + 1}">
                </a>
            </li>

            <li class="page-item" th:classappend="${tasks.last} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/tasks(page=${tasks.number + 1},
                                     size=${size},
                                     title=${title},
                                     status=${status},
                                     categoryId=${categoryId},
                                     sortProperty=${sortProperty},
                                     sortDirection=${sortDirection})}">
                    Następna ›
                </a>
            </li>

            <li class="page-item" th:classappend="${tasks.last} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/tasks(page=${tasks.totalPages - 1},
                                     size=${size},
                                     title=${title},
                                     status=${status},
                                     categoryId=${categoryId},
                                     sortProperty=${sortProperty},
                                     sortDirection=${sortDirection})}">
                    Ostatnia »
                </a>
            </li>

        </ul>
    </nav>

</div>

<th:block th:replace="~{fragments/footer :: footer}"></th:block>
</body>
</html>
